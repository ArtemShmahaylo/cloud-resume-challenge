---
- name: Build Vite App and Upload to S3
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - "{{ playbook_dir }}/vaults/prod.yml"

  vars:
    bucket_name: "www.artemshmahaylo.com"
    project_root: "{{ playbook_dir | realpath }}/../.."
    node_dir: "{{ project_root }}/frontend"
    build_dir: "{{ project_root }}/frontend/dist"

  tasks:
    - name: Install Node dependencies (clean, reproducible)
      community.general.npm:
        path: "{{ node_dir }}"
        state: present
        production: false
        ci: true

    - name: Build Vite app
      ansible.builtin.command: npm run build
      args:
        chdir: "{{ node_dir }}"
      changed_when: true

    - name: Confirm build dir exists
      ansible.builtin.stat:
        path: "{{ build_dir }}"
      register: build_stat

    - name: Fail if build output missing
      ansible.builtin.fail:
        msg: "Build dir {{ build_dir }} not found. Check 'npm run build'."
      when: not build_stat.stat.exists

    - name: Sync static assets with long cache-control
      community.aws.s3_sync:
        bucket: "{{ bucket_name }}"
        file_root: "{{ build_dir }}"
        include: "assets/**"
        delete: true
        cache_control: "public, max-age=31536000, immutable"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ AWS_REGION }}"
      register: sync_assets

    - name: Upload index.html with no-store (SPA routing)
      amazon.aws.s3_object:
        bucket: "{{ bucket_name }}"
        object: "index.html"
        src: "{{ build_dir }}/index.html"
        mode: put
        metadata:
          Cache-Control: "no-store"
          Content-Type: "text/html; charset=utf-8"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ AWS_REGION }}"
      register: upload_index

    - name: Sync remaining top-level files (short cache)
      community.aws.s3_sync:
        bucket: "{{ bucket_name }}"
        file_root: "{{ build_dir }}"
        exclude: "assets/**,index.html"
        delete: false
        cache_control: "public, max-age=300"
        aws_access_key: "{{ AWS_ACCESS_KEY_ID }}"
        aws_secret_key: "{{ AWS_SECRET_ACCESS_KEY }}"
        region: "{{ AWS_REGION }}"
      register: sync_misc

    - name: Deployment summary
      ansible.builtin.debug:
        msg:
          - "Frontend deployed to S3 bucket '{{ bucket_name }}'"
          - "Assets synced: {{ sync_assets.changed }}"
          - "Index uploaded: {{ upload_index.changed }}"
          - "Misc synced: {{ sync_misc.changed }}"